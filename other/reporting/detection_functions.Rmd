---
title: "CeMoRe Detection Function Exploration"
author: "Elise Keppel"
date: "`r Sys.Date()`"
output: pdf_document
fig_caption: true
filename: "detection_functions_hw"
---

```{r setup, include=FALSE, message = FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, cache = T)
source("../R/0 Setup.R")
```

<!-- # ```{r load_spatial} -->
<!-- # if(!exists("coast")){ -->
<!-- # coast <- sf::st_read(dsn = "shapefiles", layer = "BC_coast_UTM9", quiet = T) -->
<!-- # } -->
<!-- # coord <- ggplot2::coord_sf(xlim = c(-125.5, -123), ylim = c(48.1, 49.5), crs = sf::st_crs(4326))  -->
<!-- # ``` -->

```{r load_data}
single = F
# all_effort <- load_effort(2021, 10, single)
# all_effort_lines <- get_effort_lines(all_effort)
# all_ap_sf <- load_sightings(year, as.numeric(month), single)

# Load previously saved data
all_effort_lines <- readRDS(paste0("../output/all_effort_lines_to ", survey_title, ".rds")) %>% 
  mutate(glare2 = ifelse(Glare == "Severe", "y","n")
)
all_ap_sf <- readRDS(paste0("../output/all_effort_sgt_to ", survey_title, ".rds"))

all_ap_sf <- all_ap_sf %>% 
  filter(!is.na(PSD_nm)) %>% 
  mutate(distance = PSD_nm * 1.852,
         beauf = as.numeric(beauf),
         glare2 = ifelse(!glare == "None" & (l_glare > -45 | r_glare < 45), "y","n")
         )
l <- sum(st_length(all_effort_lines))
w = 1 # km
a <- l * w * 2

sp = "Humpback"
sf <- all_ap_sf %>% filter(Species == sp)
df <- sf %>% data.frame()
sf_ret <- sf %>% filter(!is.na(Reticle))
# see how many lines affected by glare
# all_effort_lines %>% as.data.frame() %>% group_by(Glare) %>% dplyr::summarise(n())
# see how many sightings affected by glare
# df %>% group_by(glare2) %>% dplyr::summarise(n())
n <-  nrow(sf)
```

# `r sp` sightings to `r year` `r month_abb`
Examine sighting distribution histograms at different bin levels to 
check for evasive behaviour or heaping (observer measurement rounding)

N = `r n`

```{r hist, fig.cap = "Bins = 30 (left) and 60 (right)"}


par(mfrow=c(1,2))
hist(sf$distance, xlab="Distance (km)", breaks=seq(0,max(sf$distance),len=30),
     main=paste0(sp, " to ", survey_title, "-30bins"), xlim = range(c(0,4)))  
hist(sf$distance, xlab="Distance (km)",breaks=seq(0,max(sf$distance),len=60),
     main=paste0(sp, " to ", survey_title, "-60bins"))
```

No apparent evasive behaviour (fewer detections around 0 distance) or heaping. 

\newpage
Examine reticle vs. eyeballed sightings to check for effects of eyeballing distance (eg. heaping/rounding again)
N = `r nrow(sf_ret)`

```{r hist-ret-only, fig.cap = "Reticle sightings only (no distances estimated by eye). Bins = 30 (left) and 60 (right). Eyeballed distance estimates close to the survey vessel removed and no apparent observer biases observed."}
par(mfrow=c(1,2))
hist(sf_ret$distance, xlab="Distance (km)",breaks=seq(0,max(sf$distance),len=30),
     main=paste0("To ", survey_title, " - 30bins - ret only"))
hist(sf_ret$distance, xlab="Distance (km)",breaks=seq(0,max(sf$distance),len=60),
     main=paste0("To ", survey_title, " - 60bins - ret only"))

```


\newpage

Compare dist hist plots from MB and RB

Number of `r sp` sightings from MB =  $`r nrow(subset(sf, vessel=="MB"))`$
Number of `r sp` sightings from RB =  $`r nrow(subset(sf, vessel=="RB"))`$

```{r hist-vessel, fig.cap="Distance frequency from MV MB (left) and MV RB (right)", fig.width=10}
par(mfrow=c(1,2))
# sf <- all_ap_sf %>% filter(Species == "Humpback")

hist(subset(sf, vessel=="MB")$distance,
     main=paste("MB: ", sp, " to ", survey_title, " -30 bins"), breaks=seq(0,max(sf$distance),len=30),
     xlab="Distance (km)")

hist(subset(sf, vessel=="RB")$distance,
     main=paste("RB: ", sp, " to ", survey_title, " -30 bins"), breaks=seq(0,max(sf$distance),len=30),
     xlab="Distance (km)", ylim = c(0,5))

sf <- sf %>% filter(vessel == "MB")
# unique(as.data.frame(all_ap_sf)[c("vessel", "Species")])
# all_ap_sf %>% filter(vessel == "RB", Species == "Humpback")
# all_ap_sf %>% filter(vessel == "MB", Species == "Humpback") %>% nrow()

```

Very few RB sightings. We will move forward with MB sightings only.

# Detection Functions
Models with truncation at 3, 2.5, 2, 1.5, 1, 0.75 and 0.5 km were initially examined. Truncation at 1.5 appears to line up well with 0.15 x probability of detection, while truncation at 2 km shows a better goodness of fit. We will begin with truncation at 2 and 1.5 km (note that the code is still in place to quickly run with other truncation distances as required).

\newpage
### Half normal

```{r hn, results = "as.is", fig.cap = "Half-normal models, with 2 and 1.5 km truncation."}
hn.3 <-ds(df, key = "hn", truncation = 3)
# hn.2.5 <-ds(df, key = "hn", truncation = 2.5)
hn.2 <-ds(df, key = "hn", truncation = 2)
hn.1.5 <-ds(df, key = "hn", truncation = 1.5)
# hn.1.25 <-ds(df, key = "hn", truncation = 1.25)
# hn.1 <-ds(df, key = "hn", truncation = 1)
# hn.0.5 <-ds(df, key = "hn", truncation = 0.5)
# hn.0.75 <-ds(df, key = "hn", truncation = 0.75)

# hn.1 <-ds(df, key = "hn", truncation = 1, adjustment = "cos")
# hn.1 <-ds(df, key = "hn", truncation = 1, adjustment = "herm")
# hn.1 <-ds(df, key = "hn", truncation = 1, adjustment = "poly")

# par(mfrow=c(1,2))
# plot_df(sp, hn.2.5)
par(mfrow=c(1,3))
plot_df(sp, hn.3)
plot_df(sp, hn.2) # TO DO try adding showpoints=FALSE into plot() in plot_df(), particularly for models wo covariates
plot_df(sp, hn.1.5)
# par(mfrow=c(1,2))
# plot_df(sp, hn.1.25)
# plot_df(sp, hn.1)
# plot_df(sp, hn.0.75)
# plot_df(sp, hn.0.5)

# par(mfrow=c(1,2))
# gof_ds(hn.2.5, main="hn.2.5") 
par(mfrow=c(1,3))
gof_ds(hn.3, main="hn.3")
gof_ds(hn.2, main="hn.2") 
gof_ds(hn.1.5, main="hn.1.5")
# gof_ds(hn.1.25, main="hn.1.25")
# gof_ds(hn.1, main="hn.1")
# gof_ds(hn.0.75, main="hn.0.75")
# gof_ds(hn.0.5, main="hn.0.5")


```

\newpage
### Hazard rate

```{r hr, results = "as.is", fig.cap = "Hazard rate models with 2 and 1.5 km truncation."}
hr.3 <-ds(df, key = "hr", truncation = 3)
# hr.2.5 <-ds(df, key = "hr", truncation = 2.5)
hr.2 <-ds(df, key = "hr", truncation = 2)
hr.1.5 <-ds(df, key = "hr", truncation = 1.5)
# hr.1.25 <-ds(df, key = "hr", truncation = 1.25)
# hr.1 <-ds(df, key = "hr", truncation = 1)
# hr.0.75 <-ds(df, key = "hr", truncation = 0.75)
# hr.0.5 <-ds(df, key = "hr", truncation = 0.5)

# hn.1 <-ds(df, key = "hn", truncation = 1, adjustment = "cos")
# hn.1 <-ds(df, key = "hn", truncation = 1, adjustment = "herm")
# hn.1 <-ds(df, key = "hn", truncation = 1, adjustment = "poly")

par(mfrow=c(1,3))
plot_df(sp, hr.3)
plot_df(sp, hr.2) # TO DO try adding showpoints=FALSE into plot() in plot_df(), particularly for models wo covariates
plot_df(sp, hr.1.5)
# par(mfrow=c(1,2))
# plot_df(sp, hr.1.25)
# plot_df(sp, hr.1)
# par(mfrow=c(1,2))
# plot_df(sp, hr.0.75)
# plot_df(sp, hr.0.5)

# par(mfrow=c(1,2))
# gof_ds(hr.2.5, main="hr.2.5") 
par(mfrow=c(1,3))
gof_ds(hr.3, main="hr.3")
gof_ds(hr.2, main="hr.2") 
gof_ds(hr.1.5, main="hr.1.5")
# par(mfrow=c(1,2))
# gof_ds(hr.1.25, main="hr.1.25")
# gof_ds(hr.1, main="hn.1")
# par(mfrow=c(1,2))
# gof_ds(hr.0.75, main="hr.0.75")
# gof_ds(hr.0.5, main="hr.0.5")
```

\newpage
### Uniform

```{r un, results = "as.is", fig.cap = "Uniform models with truncation at 2 km (left) and 1 km (right)."}
un.3 <-ds(df, key = "unif", truncation = 3)
un.2 <-ds(df, key = "unif", truncation = 2)
un.1.5 <- ds(df, key ="unif", truncation = 1.5)

par(mfrow=c(1,3))
plot_df(sp, un.3  ) 
plot_df(sp, un.2  )
plot_df(sp, un.1.5)

par(mfrow=c(1,3))
gof_ds(un.3  , main="un.2") 
gof_ds(un.2  , main="un.2") 
gof_ds(un.1.5, main="un.1.5")
```

```{r hr_hn}
model.table.3km <- summarize_ds_models(hn.3, 
                                   hr.3,
                                   un.3,
                                   output="plain") 
kableExtra::kable(model.table.3km, digits=3, row.names = FALSE, escape=FALSE,
      caption = paste(sp, " - Comparison of half normal, hazard rate, uniform models. Truncation = 3 km.")) %>%
  kableExtra::landscape()
#-----------------------------------------
model.table.2km <- summarize_ds_models(hn.2, 
                                   hr.2,
                                   un.2,
                                   output="plain") 
kableExtra::kable(model.table.3km, digits=3, row.names = FALSE, escape=FALSE,
      caption = paste(sp, " - Comparison of half normal, hazard rate, uniform models. Truncation = 2 km.")) %>%
  kableExtra::landscape()
#------------------------------------
model.table.1.5km <- summarize_ds_models(hn.1.5, 
                                   hr.1.5, 
                                   un.1.5,
                                   output="plain") 

kableExtra::kable(model.table.1.5km, digits=3, row.names = FALSE, escape=FALSE,
      caption = paste(sp, " - Comparison of half normal and hazard rate, uniform models. Truncation = 1.5 km.")) %>%
  kableExtra::landscape()
```

\newpage
# Covariates
## Beaufort    # TO DO : ask Brianna about beaufort - grouping, continuous
Try including covariates in the detection functions. 
Note that there's a broad range of probabilities of detection estimated for some models that get averaged out in the summary.
Can be examined using p_dist_table().
Also, run `gof_ds()` on each of our models and look at the corresponding plots

```{r beau}
table(df$beauf)

all_effort_lines_sum <- all_effort_lines %>% mutate(length_km = as.numeric(st_length(geometry))/1000) %>% 
  as.data.frame() %>% mutate(Bf = factor(Bf, levels = c(0,1,2,3,4,5)))
df_sum <- df %>%
  group_by(beauf) %>% summarise(Observations = sum(BestNumber)) %>% 
  as.data.frame() 

par(mfrow=c(1,2))
# hist(df$Bf, #breaks=seq(0, 5, by=1),
#      main="Obs per Beaufort level",
#      xlab="Beaufort")
ggplot(all_effort_lines_sum, aes(x=Bf, y=length_km)) + 
  geom_bar(stat = "identity")
ggplot(df_sum, aes(x=beauf, y=Observations)) + 
  geom_bar(stat = "identity")

# hist(all_effort_lines$Bf, breaks=seq(0, 5, by=1),
#      main="Segs per Beaufort level",
#      xlab="Beaufort") # except this assumes one Bf value per segment (which makes sense for count models (segment level covariates), but not 

# bf <- suppressMessages(ggplot()) +
#   geom_boxplot(data = all_effort_lines_sum, aes(Bf, length_km))
# estimated abundance models (observation-level covariates)
#------------------------------------------------------------------
hn.bf3 <- ds(data=df, truncation=3, key="hn", formula=~beauf)
hr.bf3 <- ds(data=df, truncation=3, key="hr", formula=~beauf)
# par(mfrow=c(1,2))
# p_dist_table(hn.bf2) %>% kableExtra::kable()
# p_dist_table(hr.bf2)%>% kableExtra::kable()

# un.bf2 <- ds(data=df, truncation=2, key="un", formula=~beauf) TO DO : why not?


par(mfrow=c(1,2))
plot_df(sp, hn.bf3)
plot_df(sp, hr.bf3)

par(mfrow=c(1,2))
gof_ds(hn.bf3, main="hn.bf3")
gof_ds(hr.bf3, main="hr.bf3")

#------------------------------------------------------------------

hn.bf2 <- ds(data=df, truncation=2, key="hn", formula=~beauf)
hr.bf2 <- ds(data=df, truncation=2, key="hr", formula=~beauf)
# par(mfrow=c(1,2))
# p_dist_table(hn.bf2) %>% kableExtra::kable()
# p_dist_table(hr.bf2)%>% kableExtra::kable()

# un.bf2 <- ds(data=df, truncation=2, key="un", formula=~beauf) TO DO : why not?


par(mfrow=c(1,2))
plot_df(sp, hn.bf2)
plot_df(sp, hr.bf2)

par(mfrow=c(1,2))
gof_ds(hn.bf2, main="hn.bf2")
gof_ds(hr.bf2, main="hr.bf2")
#------------------------------------------------------------------

hn.bf1.5 <- ds(data=df, truncation=1.5, key="hn", formula=~beauf)
hr.bf1.5 <- ds(data=df, truncation=1.5, key="hr", formula=~beauf)
# par(mfrow=c(1,2))
# p_dist_table(hn.bf1.5) %>% kableExtra::kable()
# p_dist_table(hr.bf1.5)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.bf1.5)
plot_df(sp, hr.bf1.5)

par(mfrow=c(1,2))
gof_ds(hn.bf1.5, main="hn.bf1.5")
gof_ds(hr.bf1.5, main="hr.bf1.5")
```

```{r beau-table}
# model_table_1km_no_cov <- summarize_ds_models(hn_2)
model.table.3km <- summarize_ds_models(hn.3, 
                                   hr.3,
                                   un.3,
                                   hn.bf3, 
                                   hr.bf3,
                                   output="plain") 
kableExtra::kable(model.table.3km, digits=3, row.names = FALSE, escape=FALSE,
      caption = paste(sp, " - Comparison of half normal and hazard rate with beaufort. Truncation = 3 km.")) %>%
  kableExtra::landscape()
#------------------------------------------------------------------

model.table.2km <- summarize_ds_models(hn.2, 
                                   hr.2,
                                   un.2,
                                   hn.bf2, 
                                   hr.bf2,
                                   output="plain") 
kableExtra::kable(model.table.2km, digits=3, row.names = FALSE, escape=FALSE,
      caption = paste(sp, " - Comparison of half normal and hazard rate with beaufort. Truncation = 2 km.")) %>%
  kableExtra::landscape()
#------------------------------------------------------------------

model.table.1.5km <- summarize_ds_models(hn.1.5, 
                                   hr.1.5, 
                                   un.1.5,
                                   hn.bf1.5,
                                   hr.bf1.5,
                                   output="plain") 

kableExtra::kable(model.table.1.5km, digits=3, row.names = FALSE, escape=FALSE,
      caption = paste(sp, " - Comparison of half normal and hazard rate with beaufort. Truncation = 1.5 km.")) %>%
  kableExtra::landscape()
```

It seems that truncation of 2 km performs better with Half Normal models, and 1.5 km performs better with Hazard Rate. We'll continue looking at models with each of these truncation distances and compare outputs (AIC and gof).

## Group size # TO DO : try binning the group sizes - and ask Brianna
Or observed group size:

```{r size}
table(df$BestNumber)

hn.sz3 <- ds(data=df, truncation=3, key="hn", formula=~BestNumber)
hr.sz3 <- ds(data=df, truncation=3, key="hr", formula=~BestNumber)
# par(mfrow=c(1,2))
# p_dist_table(hn.sz2) %>% kableExtra::kable()
# p_dist_table(hr.sz2)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.sz3)
plot_df(sp, hr.sz3)

par(mfrow=c(1,2))
gof_ds(hn.sz3, main="hn.sz3")
gof_ds(hr.sz3, main="hr.sz3")

#----------------------------------------------------------------
hn.sz2 <- ds(data=df, truncation=2, key="hn", formula=~BestNumber)
hr.sz2 <- ds(data=df, truncation=2, key="hr", formula=~BestNumber)
# par(mfrow=c(1,2))
# p_dist_table(hn.sz2) %>% kableExtra::kable()
# p_dist_table(hr.sz2)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.sz2)
plot_df(sp, hr.sz2)

par(mfrow=c(1,2))
gof_ds(hn.sz2, main="hn.sz2")
gof_ds(hr.sz2, main="hr.sz2")
#----------------------------------------------------------------


hn.sz1.5 <- ds(data=df, truncation=1.5, key="hn", formula=~BestNumber)
hr.sz1.5 <- ds(data=df, truncation=1.5, key="hr", formula=~BestNumber)
# par(mfrow=c(1,2))
# p_dist_table(hn.sz1.5) %>% kableExtra::kable()
# p_dist_table(hr.sz1.5)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.sz1.5)
plot_df(sp, hr.sz1.5)

par(mfrow=c(1,2))

gof_ds(hn.sz1.5, main="hn.sz1.5")
gof_ds(hr.sz1.5, main="hr.sz1.5")

```

```{r size-table}
model.table.3km <- summarize_ds_models(hn.3, 
                                   hn.bf3, 
                                   hn.sz3, 
                                   
                                   un.3,

                                   hr.3, 
                                   hr.bf3, 
                                   hr.sz3, 
                                   output="plain") 
tab.ft3 <-  model.table.3km$`Key function`[which(nchar(model.table.3km$`Key function`) >11)]

model.table.3km %<>% mutate(`Key function` = case_when(
    nchar(`Key function`)>12 ~ paste0(substring(`Key function`, 1,11),"*"),
    nchar(`Key function`) <=12 ~ `Key function`))
# saveRDS(model_table_2km, "model_table_2km.rds")

kableExtra::kable(model.table.3km, digits=3, row.names = FALSE, escape=FALSE,
      caption = paste(sp, " - Comparison of half normal and hazard rate with sea state and group size. Truncation = 3 km.")) %>%
  kableExtra::footnote(paste0("* ", tab.ft3)) %>% 
  kableExtra::landscape()
#--------------------------------------------------
model.table.2km <- summarize_ds_models(hn.2, 
                                   hn.bf2, 
                                   hn.sz2, 
                                   
                                   un.2,

                                   hr.2, 
                                   hr.bf2, 
                                   hr.sz2, 
                                   output="plain") 
tab.ft2 <-  model.table.2km$`Key function`[which(nchar(model.table.2km$`Key function`) >11)]

model.table.2km %<>% mutate(`Key function` = case_when(
    nchar(`Key function`)>12 ~ paste0(substring(`Key function`, 1,11),"*"),
    nchar(`Key function`) <=12 ~ `Key function`))
# saveRDS(model_table_2km, "model_table_2km.rds")

kableExtra::kable(model.table.2km, digits=3, row.names = FALSE, escape=FALSE,
      caption = paste(sp, " - Comparison of half normal and hazard rate with sea state and group size. Truncation = 2 km.")) %>%
  kableExtra::footnote(paste0("* ", tab.ft2)) %>% 
  kableExtra::landscape()
#--------------------------------------------------
model.table.1.5km <- summarize_ds_models(hn.1.5, 
                                   hn.bf1.5, 
                                   hn.sz1.5, 
                                   
                                   un.1.5,

                                   hr.1.5, 
                                   hr.bf1.5, 
                                   hr.sz1.5, 
                                   output="plain") 
tab.ft1.5 <-  model.table.1.5km$`Key function`[which(nchar(model.table.1.5km$`Key function`) >11)]

model.table.1.5km %<>% mutate(`Key function` = case_when(
    nchar(`Key function`)>12 ~ paste0(substring(`Key function`, 1,11),"*"),
    nchar(`Key function`) <=12 ~ `Key function`))
# saveRDS(model_table_2km, "model_table_2km.rds")

kableExtra::kable(model.table.1.5km, digits=3, row.names = FALSE, escape=FALSE,
      caption = paste(sp, " - Comparison of half normal and hazard rate with sea state and group size. Truncation = 1.5 km.")) %>%
  kableExtra::footnote(paste0("* ", tab.ft1.5)) %>% 
  kableExtra::landscape()
```

\newpage
## Beaufort & group size
We can also include the observed group size along with Beaufort:

```{r beau-size}
hn.bf.sz3 <- ds(data=df, truncation=3, key="hn", formula=~beauf+BestNumber)
hr.bf.sz3 <- ds(data=df, truncation=3, key="hr", formula=~beauf+BestNumber)
# par(mfrow=c(1,2))
# p_dist_table(hn.bf.sz2) %>% kableExtra::kable()
# p_dist_table(hr.bf.sz2)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.bf.sz3)
plot_df(sp, hr.bf.sz3)

par(mfrow=c(1,2))
gof_ds(hn.bf.sz3, main="hn.bf.sz3")
gof_ds(hr.bf.sz3, main="hr.bf.sz3")
#--------------------------------------------------------------------
hn.bf.sz2 <- ds(data=df, truncation=2, key="hn", formula=~beauf+BestNumber)
hr.bf.sz2 <- ds(data=df, truncation=2, key="hr", formula=~beauf+BestNumber)
# par(mfrow=c(1,2))
# p_dist_table(hn.bf.sz2) %>% kableExtra::kable()
# p_dist_table(hr.bf.sz2)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.bf.sz2)
plot_df(sp, hr.bf.sz2)

par(mfrow=c(1,2))
gof_ds(hn.bf.sz2, main="hn.bf.sz2")
gof_ds(hr.bf.sz2, main="hr.bf.sz2")
#--------------------------------------------------------------------
hn.bf.sz1.5 <- ds(data=df, truncation=1.5, key="hn", formula=~beauf+BestNumber)
hr.bf.sz1.5 <- ds(data=df, truncation=1.5, key="hr", formula=~beauf+BestNumber)
# par(mfrow=c(1,2))
# p_dist_table(hn.bf.sz1.5) %>% kableExtra::kable()
# p_dist_table(hr.bf.sz1.5)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.bf.sz1.5)
plot_df(sp, hr.bf.sz1.5)

par(mfrow=c(1,2))
gof_ds(hn.bf.sz1.5, main="hn.bf.sz1.5")
gof_ds(hr.bf.sz1.5, main="hr.bf.sz1.5")
```

## Glare
<!-- Or glare: -->

<!-- ```{r glare} -->
<!-- hn.gl2 <- ds(data=df, truncation=2, key="hn", adjustment=NULL, formula=~glare2) -->
<!-- # hr.gl2 <- ds(data=df, truncation=2, key="hr", adjustment=NULL, formula=~glare2) -->
<!-- # par(mfrow=c(1,2)) -->
<!-- # p_dist_table(hn.sz2) %>% kableExtra::kable() -->
<!-- # p_dist_table(hr.sz2)%>% kableExtra::kable() -->

<!-- # par(mfrow=c(1,2)) -->
<!-- plot_df(sp, hn.gl2) -->
<!-- # plot_df(sp, hr.gl2) -->

<!-- # par(mfrow=c(1,2)) -->
<!-- gof_ds(hn.gl2, main="hn.gl2") -->
<!-- # gof_ds(hr.gl2, main="hr.gl2") -->


<!-- # hn.gl1 <- ds(data=df, truncation=1, key="hn", adjustment=NULL, formula=~glare2) -->
<!-- hr.gl1 <- ds(data=df, truncation=1, key="hr", adjustment=NULL, formula=~glare2) -->
<!-- # par(mfrow=c(1,2)) -->
<!-- # p_dist_table(hn.sz1) %>% kableExtra::kable() -->
<!-- # p_dist_table(hr.sz1)%>% kableExtra::kable() -->

<!-- par(mfrow=c(1,2)) -->
<!-- plot_df(sp, hn.gl1) -->
<!-- plot_df(sp, hr.gl1) -->

<!-- par(mfrow=c(1,2)) -->

<!-- gof_ds(hn.gl1, main="hn.gl1") -->
<!-- gof_ds(hr.gl1, main="hr.gl1") -->

<!-- ``` -->
Hazard-rate with truncation at 2 km, and both hazard-rate and half-normal with truncation at 1 km don't converge.
There is only one sighting of HW with glare, so is not considered in this detection function.

\newpage
## Swell
Or swell:

```{r swell}
table(df$swell)
# ---------------------------------------------
hn.sw3 <- ds(data=df, truncation=3, key="hn", formula=~swell)
hr.sw3 <- ds(data=df, truncation=3, key="hr", formula=~swell)
# par(mfrow=c(1,2))
# p_dist_table(hn.sz2) %>% kableExtra::kable()
# p_dist_table(hr.sz2)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.sw3)
plot_df(sp, hr.sw3)

par(mfrow=c(1,2))
gof_ds(hn.sw3, main="hn.sw3")
gof_ds(hr.sw3, main="hr.sw3")
# ---------------------------------------------
hn.sw2 <- ds(data=df, truncation=2, key="hn", formula=~swell)
hr.sw2 <- ds(data=df, truncation=2, key="hr", formula=~swell)
# par(mfrow=c(1,2))
# p_dist_table(hn.sz2) %>% kableExtra::kable()
# p_dist_table(hr.sz2)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.sw2)
plot_df(sp, hr.sw2)

par(mfrow=c(1,2))
gof_ds(hn.sw2, main="hn.sw2")
gof_ds(hr.sw2, main="hr.sw2")
# ---------------------------------------------

hn.sw1.5 <- ds(data=df, truncation=1.5, key="hn", formula=~swell)
hr.sw1.5 <- ds(data=df, truncation=1.5, key="hr", formula=~swell)
# par(mfrow=c(1,2)
# p_dist_table(hn.sz1.5) %>% kableExtra::kable()
# p_dist_table(hr.sz1.5)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.sw1.5)
plot_df(sp, hr.sw1.5)

par(mfrow=c(1,2))
gof_ds(hn.sw1.5, main="hn.sw1.5")
gof_ds(hr.sw1.5, main="hr.sw1.5")

```




\newpage
## Beaufort, group size and swell
We can also include the observed group size along with Beaufort and swell:

```{r beau-size-swell}
hn.sz.sw3 <- ds(data=df, truncation=3, key="hn", formula=~BestNumber+swell)
hr.sz.sw3 <- ds(data=df, truncation=3, key="hr", formula=~BestNumber+swell)
par(mfrow=c(1,2))
plot_df(sp, hn.sz.sw3)
plot_df(sp, hr.sz.sw3)

par(mfrow=c(1,2))
gof_ds(hn.sz.sw3, main="hn.sz.sw3")
gof_ds(hr.sz.sw3, main="hr.sz.sw3")
#------------------------------
hn.sz.sw2 <- ds(data=df, truncation=2, key="hn", formula=~BestNumber+swell)
hr.sz.sw2 <- ds(data=df, truncation=2, key="hr", formula=~BestNumber+swell)

par(mfrow=c(1,2))
plot_df(sp, hn.sz.sw2)
plot_df(sp, hr.sz.sw2)

par(mfrow=c(1,2))
gof_ds(hn.sz.sw2, main="hn.sz.sw2")
gof_ds(hr.sz.sw2, main="hr.sz.sw2")
#------------------------------
hn.bf.sw3 <- ds(data=df, truncation=3, key="hn", formula=~beauf+swell)
hr.bf.sw3 <- ds(data=df, truncation=3, key="hr", formula=~beauf+swell)
par(mfrow=c(1,2))
plot_df(sp, hn.bf.sw3)
plot_df(sp, hr.bf.sw3)

par(mfrow=c(1,2))
gof_ds(hn.bf.sw3, main="hn.bf.sw3")
gof_ds(hr.bf.sw3, main="hr.bf.sw3")
#------------------------------
hn.bf.sw2 <- ds(data=df, truncation=2, key="hn", formula=~beauf+swell)
hr.bf.sw2 <- ds(data=df, truncation=2, key="hr", formula=~beauf+swell)
par(mfrow=c(1,2))
plot_df(sp, hn.bf.sw2)
plot_df(sp, hr.bf.sw2)

par(mfrow=c(1,2))
gof_ds(hn.bf.sw2, main="hn.bf.sw2")
gof_ds(hr.bf.sw2, main="hr.bf.sw2")
#------------------------------

hn.bf.sz.sw3 <- ds(data=df, truncation=3, key="hn", formula=~beauf+BestNumber+swell)
hr.bf.sz.sw3 <- ds(data=df, truncation=3, key="hr", formula=~beauf+BestNumber+swell)
# par(mfrow=c(1,2)
# p_dist_table(hn.bf.sz2) %>% kableExtra::kable()
# p_dist_table(hr.bf.sz2)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.bf.sz.sw3)
plot_df(sp, hr.bf.sz.sw3)

par(mfrow=c(1,2))
gof_ds(hn.bf.sz.sw3, main="hn.bf.sz.sw3")
gof_ds(hr.bf.sz.sw3, main="hr.bf.sz.sw3")
#------------------------------

hn.bf.sz.sw2 <- ds(data=df, truncation=2, key="hn", formula=~beauf+BestNumber+swell)
hr.bf.sz.sw2 <- ds(data=df, truncation=2, key="hr", formula=~beauf+BestNumber+swell)
# par(mfrow=c(1,2)
# p_dist_table(hn.bf.sz2) %>% kableExtra::kable()
# p_dist_table(hr.bf.sz2)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.bf.sz.sw2)
plot_df(sp, hr.bf.sz.sw2)

par(mfrow=c(1,2))
gof_ds(hn.bf.sz.sw2, main="hn.bf.sz.sw2")
gof_ds(hr.bf.sz.sw2, main="hr.bf.sz.sw2")
#-----------------------------------------
hn.sz.sw1.5 <- ds(data=df, truncation=1.5, key="hn", formula=~BestNumber+swell)
hr.sz.sw1.5 <- ds(data=df, truncation=1.5, key="hr", formula=~BestNumber+swell)
par(mfrow=c(1,2))
plot_df(sp, hn.sz.sw1.5)
plot_df(sp, hr.sz.sw1.5)

par(mfrow=c(1,2))
gof_ds(hn.sz.sw1.5, main="hn.sz.sw1.5")
gof_ds(hr.sz.sw1.5, main="hr.sz.sw1.5")

hn.bf.sw1.5 <- ds(data=df, truncation=1.5, key="hn", formula=~beauf+swell)
hr.bf.sw1.5 <- ds(data=df, truncation=1.5, key="hr", formula=~beauf+swell)
par(mfrow=c(1,2))
plot_df(sp, hn.bf.sw1.5)
plot_df(sp, hr.bf.sw1.5)

par(mfrow=c(1,2))
gof_ds(hn.bf.sw1.5, main="hn.bf.sw1.5")
gof_ds(hr.bf.sw1.5, main="hr.bf.sw1.5")

hn.bf.sz.sw1.5 <- ds(data=df, truncation=1.5, key="hn", formula=~beauf+BestNumber+swell)
hr.bf.sz.sw1.5 <- ds(data=df, truncation=1.5, key="hr", formula=~beauf+BestNumber+swell)
# par(mfrow=c(1,2)
# p_dist_table(hn.bf.sz1.5) %>% kableExtra::kable()
# p_dist_table(hr.bf.sz1.5)%>% kableExtra::kable()

par(mfrow=c(1,2))
plot_df(sp, hn.bf.sz.sw1.5)
plot_df(sp, hr.bf.sz.sw1.5)

par(mfrow=c(1,2))
gof_ds(hn.bf.sz.sw1.5, main="hn.bf.sz.sw1.5")
gof_ds(hr.bf.sz.sw1.5, main="hr.bf.sz.sw1.5")
```




**Comparing Q-Q plots**

Run `gof_ds()` on each of our models and look at the corresponding plots arranged in a grid

<!-- # ```{r qq-compare, fig.width=5, fig.height=8} -->
<!-- # # make a grid, 3 rows by 2 columns -->
<!-- # par(mfrow=c(2,2)) -->
<!-- #  -->
<!-- # gof_ds(hn.2, main="hn.2")  -->
<!-- # gof_ds(hn.1, main="hn.1") -->
<!-- # gof_ds(hr.2, main="hr.2") -->
<!-- # gof_ds(hr.1, main="hr.1") -->
<!-- #  -->
<!-- # par(mfrow=c(2,2)) -->
<!-- # gof_ds(hn.bf2, main="hn.bf2") -->
<!-- # gof_ds(hn.bf1, main="hn.bf1") -->
<!-- # gof_ds(hr.bf2, main="hr.bf2") -->
<!-- # gof_ds(hr.bf1, main="hr.bf1") -->
<!-- #  -->
<!-- # par(mfrow=c(2,2)) -->
<!-- # gof_ds(hn.sz2, main="hn.sz2") -->
<!-- # gof_ds(hn.sz1, main="hn.sz1") -->
<!-- # gof_ds(hr.sz2, main="hr.sz2") -->
<!-- # gof_ds(hr.sz1, main="hr.sz1") -->
<!-- #  -->
<!-- # par(mfrow=c(2,2)) -->
<!-- # gof_ds(hn.bf.sz2, main="hn.bf.sz2") -->
<!-- # gof_ds(hn.bf.sz1, main="hn.bf.sz1") -->
<!-- # gof_ds(hr.bf.sz2, main="hr.bf.sz2") -->
<!-- # gof_ds(hr.bf.sz1, main="hr.bf.sz1") -->
<!-- #  -->
<!-- #  -->
<!-- # ``` -->




```{r hr_hn_bf_sz}
# model_table_1km_no_cov <- summarize_ds_models(hn_2)

model.table.3km <- summarize_ds_models(hn.3, 
                                       hn.bf3, 
                                       hn.sz3, 
                                       hn.sw3,
                                       
                                       hn.bf.sz3,
                                       hn.bf.sw3,
                                       hn.sz.sw3,
                                       hn.bf.sz.sw3, 
                                       
                                       un.3,
                                       
                                       hr.3, 
                                       hr.bf3, 
                                       hr.sz3, 
                                       hr.sw3,
                                       
                                       hr.bf.sz3,
                                       hr.bf.sw3,
                                       hr.sz.sw3,
                                       hr.bf.sz.sw3, 
                                       output="plain") 
tab.ft3 <-  model.table.3km$`Key function`[which(nchar(model.table.3km$`Key function`) >11)]

model.table.3km %<>% mutate(`Key function` = case_when(
    nchar(`Key function`)>12 ~ paste0(substring(`Key function`, 1,11),"*"),
    nchar(`Key function`) <=12 ~ `Key function`))

kableExtra::kable(model.table.3km, digits=3, row.names = FALSE, escape=FALSE,
      caption = paste(sp, " - Comparison of half normal and hazard rate with sea state, group size, swell. Truncation = 3 km.")) %>%
  kableExtra::footnote(paste0("* ", tab.ft3)) %>% 
  kableExtra::landscape()
#------------------------------------------------------------
model.table.2km <- summarize_ds_models(hn.2, 
                                       hn.bf2, 
                                       hn.sz2, 
                                       hn.sw2,
                                       
                                       hn.bf.sz2,
                                       hn.bf.sw2,
                                       hn.sz.sw2,
                                       hn.bf.sz.sw2, 
                                       
                                       un.2,
                                       
                                       hr.2, 
                                       hr.bf2, 
                                       hr.sz2, 
                                       hr.sw2,
                                       
                                       hr.bf.sz2,
                                       hr.bf.sw2,
                                       hr.sz.sw2,
                                       hr.bf.sz.sw2, 
                                       output="plain") 
tab.ft2 <-  model.table.2km$`Key function`[which(nchar(model.table.2km$`Key function`) >11)]

model.table.2km %<>% mutate(`Key function` = case_when(
    nchar(`Key function`)>12 ~ paste0(substring(`Key function`, 1,11),"*"),
    nchar(`Key function`) <=12 ~ `Key function`))

kableExtra::kable(model.table.2km, digits=3, row.names = FALSE, escape=FALSE,
      caption = paste(sp, " - Comparison of half normal and hazard rate with sea state, group size, swell. Truncation = 2 km.")) %>%
  kableExtra::footnote(paste0("* ", tab.ft2)) %>% 
  kableExtra::landscape()
#------------------------------------------------------------
model.table.1.5km <- summarize_ds_models(hn.1.5, 
                                         hn.bf1.5, 
                                         hn.sz1.5,
                                         hn.sw1.5,
                                         
                                         hn.bf.sz1.5,
                                         hn.bf.sw1.5,
                                         hn.sz.sw1.5,
                                         hn.bf.sz.sw1.5, 
                                         
                                         un.1.5,
                                         
                                         hr.1.5, 
                                         hr.bf1.5, 
                                         hr.sz1.5,
                                         hr.sw1.5,
                                         
                                         hr.bf.sz1.5,
                                         hr.bf.sw1.5,
                                         hr.sz.sw1.5, 
                                         hr.bf.sz.sw1.5, 
                                         output="plain") 
tab.ft1.5 <-  model.table.1.5km$`Key function`[which(nchar(model.table.1.5km$`Key function`) >11)]

model.table.1.5km %<>% mutate(`Key function` = case_when(
    nchar(`Key function`)>12 ~ paste0(substring(`Key function`, 1,11),"*"),
    nchar(`Key function`) <=12 ~ `Key function`))

kableExtra::kable(model.table.1.5km, digits=3, row.names = FALSE, escape=FALSE,
      caption = paste(sp, " - Comparison of half normal and hazard rate with sea state and group size. Truncation = 1.5 km.")) %>% 
  kableExtra::footnote(paste0("* ", tab.ft1.5)) %>% 
  kableExtra::landscape()
```

# Adjustment terms

```{r try_different_adjustment_terms}
hn.cos2 <- ds(data=df, truncation=1.5, key="hn", adjustment="cos", order =2)
hn.cos3 <- ds(data=df, truncation=1.5, key="hn", adjustment="cos", order = 3)
hn.cos4 <- ds(data=df, truncation=1.5, key="hn", adjustment="cos", order = 4)
hn.herm2 <- ds(data=df, truncation=1.5, key="hn", adjustment="herm", order =2)
hn.herm3 <- ds(data=df, truncation=1.5, key="hn", adjustment="herm", order = 3)
hn.herm4 <- ds(data=df, truncation=1.5, key="hn", adjustment="herm", order = 4)
hn.poly2 <- ds(data=df, truncation=1.5, key="hn", adjustment=  "poly", order = 2) # for poly, must input even orders
hn.poly4 <- ds(data=df, truncation=1.5, key="hn", adjustment= "poly", order = 4)
hn.poly6 <- ds(data=df, truncation=1.5, key="hn", adjustment="poly", order = 6)

model.table.1.5km.w.adj <- summarize_ds_models(hn.cos2, 
                                       hn.cos3, 
                                       hn.cos4,
                                       hn.herm2, 
                                       hn.herm3, 
                                       hn.herm4,
                                       hn.poly2,
                                       hn.poly4,
                                       hn.poly6,
                                       output="plain") 

names(model.table.1.5km.w.adj)[c(5,6)] <- c("Avg det**", "se(Avg det)**")
# saveRDS(model.table.1.5km.w.adj, "model.table.1.5km.w.adj.rds")

kableExtra::kable(model.table.1.5km.w.adj, digits=3, row.names = FALSE, escape=FALSE,
      caption = "Comparison of half normal model w adjustments. Truncation = 1.5 km.") %>% 
  kableExtra::landscape() %>% 
  kableExtra::footnote("** Avg det = Average detectability")


```




<!-- **Calculating the Horvitz-Thompson estimate** -->

```{r ht-estimate}
# total area of the region we want to estimate abundance for
# run this in create_transects.R in cemore_design:
# Full_study_area@region %>% st_as_sf() %>% st_area() %>% sum()/1000000 
# OR  sum(Full_study_area@area)/1000000
A <- 5039.467 #km^2

# total area we surveyed (2wL)
l <- round(sum(st_length(all_effort_lines))/1000) %>% as.numeric() # total length of surveyed transects in km
w <- 1 # truncation distance in km
a <- 2 * w * l

# # group sizes
# group_sizes <- hr.bf1$ddf$data$BestNumber
# # need to get those that are within truncation!
# group_sizes <- group_sizes[hr.bf1$ddf$data$distance <= 1] # PAUSED HERE working from github>training>online dsm>practicals>01
# 
# # probabilities of detection
# probs <- predict(df_hr_beau)$fitted
# 
# # now the H-T estimator
# 
# Nhat_hr_beau <- (A/a) * sum(group_sizes/probs)
# Nhat_hr_beau
```